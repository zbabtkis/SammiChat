angular.module("Storage",[]).service("DB",["$rootScope","$window","$q",function(a,b,c){function d(a,b){var c=Object.keys(values),d=c.map(function(a){return a+"="+values[a]});return d.join(b)}var e=null,f={},g="SammiApp",h="",i="SammiApp Data Storage",j=1e5,k="deviceready",l=!0,m=!1;this.initialize=function(c){document.addEventListener(k,function(){e=b.openDatabase(g,h,i,j),c&&c.runUpdates(),_dbready=!0,l?a.$emit("dbready"):a.$on("updatesComplete",function(){a.$emit("dbready")})})},f.query=function(a){var b=[].slice.call(arguments,1),d=c.defer();return e.transaction(function(c){a.apply(f,[c].concat(b).concat([d]))},d.reject,d.resolve),d.promise},f.QUERY=function(a,b,c){var d=[].slice.call(arguments,1).concat([c.resolve,c.reject]);a.executeSql.apply(a,d)},f.INSERT=function(a,b,c,d){var e=Object.keys(c).join(","),f=e.map(function(a){return c[a]});a.executeSql("INSERT INTO "+b+" ("+e.join(",")+") VALUES ("+ +f.join(",")+")",[],d.resolve,d.reject)},f.SELECT=function(a,b,c,e,f){var c=c?c.join(","):"*",e=e?" WHERE "+d(e," AND "):"";a.executeSql("SELECT "+c+" FROM "+b+e,[],f.resolve,f.reject)},f.UPDATE=function(a,b,c,e,f){var g=(Object.keys(c).join(","),d(c," , ")),e=d(e," AND ");a.executeSql("UPDATE "+b+" "+g+" WHERE"+e,[],f.resolve,f.reject)},f.DELETE=function(a,b,c,e){a.executeSql("DELETE FROM "+b+" WHERE "+d(c," AND "),[],e.resolve,e.reject)},f.CREATE_TABLE=function(a,b,c,d,e){var f=[];for(var g in c)c.hasOwnProperty(g)&&f.push([g].concat(c[g]).join(" "));a.executeSql("CREATE TABLE IF NOT EXISTS "+b+" ("+f.join(",")+")",[],d,e)},this.exists=function(){return!!m},this.UPGRADE=function(){return _updatesDone=!1,!0},this.Migration=function(){var b=[],c=[];return{migrate:function(a,d){var f=this;c.push(a),b[a]=function(){e.changeVersion(e.version,a,d,function(){},f.fail)}},runUpdates:function(){var a="1.0"===e.version?0:e.version;l=!1,""===e.version&&this.success(),c=c.reduce(function(b,c){return a>=c?b.concat(c):b},[]),this.runUpdate()},version:function(){var a=c.indexOf(Math.min(c)),b=c[a];return c=c.slice(a,1),b},runUpdate:function(){var a=this.version();"undefined"!=typeof a?b[a](e).then(this.runUpdate,this.fail):this.success()},fail:function(a){console.error&&console.error(a)},success:function(){l=!0,a.$broadcast("updatesComplete")}}},this.requestDB=function(){var b=c.defer();return m&&l?b.resolve(f):a.$on("dbready",function(){b.resolve(f)}),b.promise}}]),function(a){var b=a.module("SammiChat",["Storage","ngRoute","ionic","ionic.ui.sideMenu"]);b.config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/instructions.html",controller:"WordCtrl"}).when("/:vocabId",{templateUrl:"views/words.html",controller:"WordCtrl"}).otherwise({redirectTo:"/"})}]),b.run(["$rootScope","DB","updates","Speak",function(a,b,c,d){b.initialize(c),d.initialize()}])}.call(this,angular),function(a){a.module("Storage").run(["DB",function(a){a.requestDB().then(function(a){a.query(a.CREATE_TABLE,"vocabularies",{id:["INTEGER","NOT NULL","PRIMARY KEY","AUTOINCREMENT"],label:["varchar(255)"]},function(){},function(a){console.log(a)})})}]),a.module("SammiChat").factory("Vocabulary",["DB","$q",function(b,c){var d=function(b){this.id=null,this.label="",this.isNew=!0,a.extend(this,b)};return d.prototype.save=function(){var a={label:this.label},c=this;b.requestDB().then(function(b){function d(a,b){c.id=b.insertId}function e(a){console.log(a)}var f=c.isNew?b.query(b.INSERT,"vocabularies",a):b.query(b.UPDATE,"vocabularies",a,{id:c.id});f.then(d,e)})},d.prototype.delete=function(){var a=this;b.requestDB().then(function(b){function c(a){console.log(a)}function d(){}var e=[b.query(b.DELETE,"vocabularies",{id:a.id}),b.query(b.DELETE,"words",{vocabulary:a.id})];$.all(e).then(c,d)})},d.query=function(a){var e=c.defer();return b.requestDB().then(function(b){function c(a,b){for(var c=[],f=0;f<b.rows.length;f++)c.push(new d(b.rows.item(f)));e.resolve(c)}function f(a){console.error&&console.error(a)}var g=a&&a.id?b.query(b.SELECT,"vocabularies",null,{id:a.id}):b.query(b.SELECT,"vocabularies");g.then(c,f)}),e.promise},d.queryOne=function(){var a=c.defer();return d.query.apply(d,arguments).then(function(b){b.length?a.resolve(b[0]):a.reject()}),a.promise},d}])}.call(this,angular),angular.module("Storage").run(["DB",function(a){a.requestDB().then(function(a){a.query(a.CREATE_TABLE,"words",{id:["INTEGER","NOT NULL","PRIMARY KEY","AUTOINCREMENT"],vocabulary:["int","NOT NULL"],text:["varchar(255)"]})})}]),angular.module("SammiChat").factory("Word",["DB","$q",function(a,b){var c=function(a){angular.extend(this,a)};return c.prototype.isNew=!0,c.prototype.save=function(){var b=this;a.requestDB().then(function(a){function c(a,c){c.insertId&&(b.id=c.insertId)}function d(a){console.log(a)}var e=b.isNew?a.query(a.INSERT,"words",{vocabulary:b.vocabulary,text:b.text}):a.query(a.UPDATE,"words",{vocabulary:b.vocabulary,text:b.text},{id:b.id});e.then(c,d)})},c.prototype.delete=function(){var b=this;a.requestDB().then(function(a){function c(){}function d(a){console.log(a)}a.query(a.DELETE,"words",{id:b.id}).then(c,d)})},c.query=function(d){var e=b.defer();return a.requestDB().then(function(a){function b(a,b){for(var d=[],f=0;f<b.rows.length;f++)d.push(new c(b.rows.item(f)));e.resolve(d)}function f(a,b){console.log(b)}var g=d?a.query(a.SELECT,"words",null,d):a.query(a.SELECT,"words");g.then(b,f)}),e.promise},c}]),angular.module("SammiChat").service("Speak",["$rootScope","$q",function(a,b){return{initialize:function(){var b;"SpeechSynthesisUtterance"in window?(this._say=function(a){var b=new SpeechSynthesisUtterance(a);window.speechSynthesis.speak(b)},this._isLoaded=!0):window.device&&"Android"===window.device.platform?(b=document.createElement("script"),b.src="tts.js",b.async=!0,document.body.appendChild(b),b.onload=function(){this._isLoaded=!0,a.broadcast("ttsLoaded",window.tts.speak)}):this._isLoaded=!0},_say:function(){},_isLoaded:!1,request:function(){var c=b.defer();return this._isLoaded?c.resolve(this._say):a.$on("ttsLoaded",c.resolve),c.promise}}}]),function(a){a.module("SammiChat").directive("sentenceReset",function(){return{restrict:"A",link:function(a,b){b.bind("click",a.resetSentence)}}}),a.module("SammiChat").directive("ngEnter",function(){return{link:function(a,b,c){function d(b){13===b.which&&(a.$apply(function(){a.$eval(c.ngEnter)}),b.preventDefault())}b.bind("keydown keypress",d)}}})}.call(this,angular),function(a){a.module("SammiChat").controller("WordCtrl",["$scope","$injector",function(b,c){var d=c.get("$routeParams"),e=c.get("$rootScope"),f=c.get("Word"),g=c.get("Vocabulary"),h=c.get("Speak");g.queryOne({id:d.vocabId}).then(function(a){b.vocabulary=a}),b.newWord=new f,b.noVocabulary=!!d.vocabId,e.currentStatement="",b.words=[],b.load=function(){var a=b.vocabulary;a&&f.query({vocabulary:a.id}).then(function(a){console.log(a),b.words=a})},b.$watch("vocabulary",b.load),b.clear=function(){b.words.forEach(function(a){a.delete()})},b.saveWord=function(a){var c=!1;a.text&&(b.words.forEach(function(b){a.text===b.text&&(c=!0)}),c||(a.text=a.text.trim(),a.isNew&&(a.vocabulary=b.vocabulary.id,b.words.push(a)),a.save(),b.newWord=new f))},e.say=function(a){h.request().then(function(b){b(a)})},b.selectWord=function(a){a.active?(e.currentStatement=e.currentStatement.replace(a.text+" ",""),a.active=!1):(e.currentStatement+=a.text+" ",b.say(a.text),a.active=!0)},b.readStatement=function(){b.read(b.currentStatement)},b.resetSentence=function(){e.currentStatement="",b.words.forEach(function(a){a.active=!1}),e.$apply()},b.deleteWord=function(a){var c=b.words.indexOf(a);a.delete(),b.words.splice(c,1)},b.editWord=function(c){b.newWord=a.copy(c),b.deleteWord(c)},b.itemButtons=[{text:"Edit",type:"button-calm",onTap:b.editWord},{text:"Delete",type:"button-assertive",onTap:b.deleteWord}],b.toggleMenu=function(){b.sideMenuController.toggleLeft()}}])}.call(this,angular),function(a){a.module("SammiChat").controller("VocabularyCtrl",["$scope","$location","Vocabulary",function(b,c,d){b.newVocabulary=new d,b.vocabularies=[],d.query().then(function(a){b.vocabularies=a}),b.setVocabulary=function(a){c.path("/"+a.id)},b.saveVocabulary=function(a){a.label=a.label.trim(),a.label&&(b.vocabularies.push(a),b.newVocabulary=new d,a.save())},b.deleteVocabulary=function(a){var c=b.vocabularies.indexOf(a);b.vocabularies.splice(c,1),a.delete()},b.editVocabulary=function(c){b.newVocabulary=a.copy(c),b.deleteVocabulary(c)},b.btns=[{text:"Edit",type:"button-calm",onTap:b.editVocabulary},{text:"Delete",type:"button-assertive",onTap:b.deleteVocabulary}]}])}.call(this,angular),function(a){a.module("SammiChat").service("updates",["DB","$q",function(a,b){var c=new a.Migration;return c.migrate(2,function(a){var c=[a.query(a.QUERY,"ALTER TABLE categories RENAME TO vocabularies"),a.query(a.QUERY,"ALTER TABLE words RENAME COLUMN category TO vocabulary")];return console.log(c),b.all(c).promise}),c}])}.call(this,angular);